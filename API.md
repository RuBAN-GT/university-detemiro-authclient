# Описание API сервера аутентификации #

Если вы решили работать с API сервера напрямую, без готового клиента, то вам необходимо знать как минимум три вещи: порядок действий, какие страницы за что отвечают, в каком формате отправлять сообщения серверу.

Лучше начать с конца.

## Формат POST-запросов ##

Для запроса подготовительной сессии или для запроса данных пользователя по его токену вы должны использовать POST-сообщения в чистом виде или в формате JSON.
**В обоих случаях должен использоваться протокол HTTPS.**

Сервер от вас будет ждать объекта (ассоциативного массива) со следующими ключами (полями):

* service - имя вашего сервиса
* secret - секретный ключ сервиса
* redirect - обратная ссылка после успешной операции
* token - токен пользователя, в случае запроса его данных

Все эти данные необходимы, чтобы сервер удостверился, что работает именно с вашим приложением, а также благодаря этому работал в специфике вашего приложения.

Если вы изучите исходники запросов клиентского php-приложения, то увидите, что оно конвертирует php-массив в JSON-строку и отпаравляет её методом POST на определённые страницы.

## Формат ответа сервера ##

В ответ на POST-запросы сервер отвечает JSON-строкой в виде чистого текста (plain text).
Такой ответ содержит объект (ассоциативный массив) со следующими полями:

* notices - массив дополнительных сообщений, например, об успехе операции
* error - массив сообщений об ошибках в запросе или операции, например, о некорректном токене пользователя
* data - целевые данные, например, хеш временного токена сессии

Само сообщение также является объектом и обычно содержит поля:

* time - время создания сообщения
* comment - пояснение сообщения
* info - краткий заголовок сообщение
* code - код сообщения для вашей независимой обработки

Пример ответа не некорректный POST-запрос:
~~~~json
{"data":null,"notices":[],"errors":[{"time":"2015-06-25T19:07:29+03:00","comment":"Клиент отправил неверный запрос, или сервис клиента не существует.","info":"Неверный запрос клиента","code":"auth.wrongRequst"}]}
~~~~

## Коды ответов сервера ##

Код                     | Тип         | Пояснение
----------------------- | ----------- | ----------------------------------------------------------------------
auth.wrongRequest       | ошибка      | Ваш клиент отправил неверный запрос или его сервис не определён
auth.unknownError       | ошибка      | Произошла неизвестная ошибка, обратитесь к администраторам
auth.tokenExpired       | ошибка      | Токен пользователя устарел
auth.successToken       | уведомление | Проверка токена прошла успешна и данные по нему получены
auth.emptyToken         | ошибка      | Проверка токена прошла успешно, НО данные по нему НЕ были получены
auth.wrongToken         | ошибка      | Неверный токен
auth.prepareSessionOK   | уведомление | Подготовка сессии прошла успешно
auth.prepareSessionFail | ошибка      | Подготовка сессии провалилась
auth.successLogout      | уведомление | Пользователь успешно удалён с сервера аутентификации
auth.wrongLogout        | ошибка      | Не удалось удалить пользователя с сервера, возможно задан неверно токен

## Страницы сервера (API) ##

Каждая страница сервера отвечает за определённую операцию, рассмотрим их подробнее.

### Подготовка сессии (/prepareSession) ###

Данная страница служит для определения вашего приложения и подготовки для пользователя сессии аутентификации.
Она ожидает от вас POST-запроса, в противном случае приведёт вас на 404 страницу.

В случае успеха json-ответ будет содержать поле data с хешем временной сессии.

### Получение данный по токена (/checkToken) ###

Данная страница служит для проверки токена, а также выдачи данных пользователя в поле data в виде json-строки.
Она ожидает от вас POST-запроса, с дополнительным полем token - токенеом пользователя, полученным после успешной аутентификации.

### Страница аутентификации (/authentication) ###

Данная страница оживает в URI параметр sessionToken, содержащий результат data со страницы prepareSession.
Если токен будет некорректен или пропущен, пользователь будет перемещён на 404 страницу.

В случае успешной аутентификации, пользователь вернётся по ссылке, указанной в redirect, с URI-параметром authToken, его и можно отправлять на checkToken.

### Страница выхода (/logout) ###

Данная страница служит для полного выхода пользователя с сервера аутентификации с удалением данных по нему.
Она ожидает от вас POST-запроса, с дополнительным полем token - токенеом пользователя, полученным после успешной аутентификации.

## Порядок операций ##

Очень важно соблюдать данный порядок действий при работе с сервером аутентификации.
Полезно будет изучить демо-клиент и прочитать README по клиентскому приложению на PHP.

### 1. Подготовка сессии ###

Здесь необходимо отправить POST-запрос на */prepareSession* с параметрами: service, secret, redirect (см. Формат POST-запросов).
В случае успеха результатом будет являться временный токен в поле data (см. Формат ответа сервера).

### 2. Редирект пользователя на страницу аутентификации ###

В случае успешного получение токена временной сессии необходимо перенаправить пользоваться на страницу */authentication* с URI параметром sessionToken, например, на */authentication?sessionToken=cheset*.

Если пользователь успешно аутентифицируется, то проверяйте в приложении URI-параметр authToken - его содержание и будет являться токеном пользователя.

Полезно будет его запомнить в куках пользователя или у себя, чтобы в дальнейшем не перенаправлять пользователя на сервер.

### 3. Получение данных ###

Теперь необходимо проверить полученных токен. Для этого необходимо обратиться на страницу */checkToken* с параметрами: service, secret, redirect, token.
В случае успеха результатом будут являться данные в поле data.

Полученный результат можно закешировать или сохранить в базе данных для облегчения повторных операций.

## Примечания ##

* Временный токен существует 2 часа.
* Для большинства сервисов постоянный токен также существует 2 часа, поэтому желательно кешировать (сохранять) полученные данные на стороне приложения.
* При пустом или неверном запросе сервер перенаправляет или запрос, или пользователя на 404 страницу.
* Если пользователь успешно аутентифицируется, то для домена сервера он получит куку с токеном аутентификации на время жизни этого токена. В результате ему не придётся повторно вводить свои персональные данные. Сама кука устанавливается с "флагом безопасности" (https://www.owasp.org/index.php/SecureFlag).